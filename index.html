<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Servidor Gemini</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#121212; --text:#e0e0e0; --btn:#1a73e8; --btn-h:#1565c0;
      --input-bg:#2c2c2c; --input-border:#444; --chat-bg:#1e1e1e;
      --profile-bg:#4a4a4a; --code-bg:#2d2d2d;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Google Sans","Roboto",sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; height:100vh;
    }
    header{
      width:100%; display:flex; align-items:center; justify-content:center;
      padding:12px 16px; position:relative;
    }
    header h1{ color:var(--btn); font-size:20px; font-weight:500; cursor:pointer; }
    .menu-btn{ position:absolute; left:14px; font-size:24px; cursor:pointer; user-select:none; }
    /* Nuevo: avatar y nombre del usuario en header */
    .user-header-info {
      position: absolute;
      right: 60px;
      display: flex;
      align-items: center;
      gap: 8px;
      max-width: 170px;
      overflow: hidden;
    }
    .user-avatar-header {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--profile-bg);
      border: 2px solid var(--btn);
      display: block;
    }
    .user-name-header {
      font-size: 15px;
      color: var(--text);
      opacity: 0.85;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    /* Bot√≥n de perfil */
    .profile-btn{
      position:absolute; right:14px; width:36px; height:36px; border-radius:50%; background:var(--profile-bg); color:white; border:none; display:flex; align-items:center; justify-content:center; padding:0; overflow:hidden;
    }
    .profile-btn img {
      width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
    }
    /* ... (resto de tu CSS no cambia) ... */
    /* Sidebar, main, footer, etc. igual que antes */
    .sidebar{
      position:fixed; top:0; left:-260px; width:250px; height:100%;
      background:#1e1e1e; padding:18px; display:flex; flex-direction:column; gap:12px;
      transition:left .28s ease; z-index:999;
    }
    .sidebar.open{ left:0; }
    .sidebar button{ background:var(--btn); color:white; border:none; border-radius:16px; padding:10px 12px; text-align:left; cursor:pointer; }
    .overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:998; }
    .overlay.show{ display:block; }
    main{
      flex-grow:1; width:100%; max-width:640px; display:flex; flex-direction:column; gap:12px;
      padding:12px; margin-bottom:86px; overflow-y:auto;
    }
    #chat-window{
      flex-grow:1; background:var(--chat-bg); border-radius:12px; padding:16px; display:flex; flex-direction:column; gap:10px; min-height:220px; overflow:auto;
    }
    .user-message, .bot-message{
      padding:10px 14px; border-radius:18px; max-width:80%; word-wrap:break-word;
    }
    .user-message{ align-self:flex-end; background:var(--btn); color:#fff; }
    .bot-message{ align-self:flex-start; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); }
    .bot-message pre{ background:var(--code-bg); padding:10px; border-radius:8px; overflow-x:auto; }
    /* ... (resto de tu CSS igual) ... */
  </style>
</head>
<body>
  <header>
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    <h1 id="header-title" onclick="location.href='about.html'">Servidor Gemini</h1>
    <!-- Nuevo: Mostrar nombre y avatar -->
    <div class="user-header-info" id="userHeaderInfo" style="display:none;">
      <img src="" alt="avatar" id="userHeaderAvatar" class="user-avatar-header">
      <span class="user-name-header" id="userHeaderName"></span>
    </div>
    <!-- Bot√≥n de perfil con avatar real -->
    <button class="profile-btn" onclick="location.href='perfil.html'">
      <img src="https://ui-avatars.com/api/?name=Usuario" id="profileBtnAvatar" alt="Perfil">
    </button>
  </header>

  <div class="sidebar" id="sidebar">
    <button onclick="newChat()">üÜï Nuevo chat</button>
    <button id="memoryBtn" onclick="toggleMemory()">üö´ Chat sin memoria</button>
    <button onclick="goToConversationsPage()">üìú Ver conversaciones</button>
    <button onclick="location.href='config.html'">‚öôÔ∏è Configuraci√≥n</button>
    <button onclick="clearAllHistory()">‚ùå Borrar todo el historial</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <main>
    <div id="chat-window"></div>
  </main>

  <footer>
    <div class="input-area">
      <div class="file-input-wrapper" title="Adjuntar archivo">
        üìé
        <input type="file" id="fileInput" multiple>
      </div>
      <textarea id="promptInput" rows="1" placeholder="Escribe tu pregunta..."></textarea>
      <button id="sendBtn" class="send-btn" onclick="askGemini()">Enviar</button>
    </div>
    <div class="model-selector">
        <label for="modelSelect">Modelo:</label>
        <select id="modelSelect">
            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
    </div>
    <div id="fileNameDisplay"></div>
  </footer>

  <div id="code-modal">
    <div class="code-content">
      <pre><code id="code-display"></code></pre>
      <div class="code-modal-actions">
        <button onclick="closeCodeModal()">Cerrar</button>
        <button onclick="copyCode()">Copiar</button>
      </div>
    </div>
  </div>

  <script>
    // BOT Version:6.2
    // ... (tu c√≥digo JS actual va aqu√≠, sin cambios importantes) ...

    // === NUEVO: Cargar perfil y mostrar en header ===
    function updateUserHeaderFromProfile() {
      const profile = JSON.parse(localStorage.getItem("userProfile") || "{}");
      // Nombre
      const userName = profile.username && profile.username.trim() ? profile.username.trim() : "Usuario";
      // Avatar
      let avatarUrl = profile.avatarUrl && profile.avatarUrl.trim() ? profile.avatarUrl.trim() : "";
      if (!avatarUrl) {
        avatarUrl = "https://ui-avatars.com/api/?name=" + encodeURIComponent(userName);
      }
      // Mostrar en header
      document.getElementById("userHeaderName").textContent = userName;
      document.getElementById("userHeaderAvatar").src = avatarUrl;
      document.getElementById("profileBtnAvatar").src = avatarUrl;
      document.getElementById("userHeaderInfo").style.display = "flex";
    }

    // Llama a esta funci√≥n cuando cargue el DOM
    document.addEventListener("DOMContentLoaded", () => {
      updateUserHeaderFromProfile();
      // ... el resto de tu c√≥digo que ya tienes ...
      // Por ejemplo:
      const savedModel = localStorage.getItem("gemini_model");
      const modelSelect = document.getElementById("modelSelect");
      if (savedModel && Array.from(modelSelect.options).some(opt => opt.value === savedModel)) {
          modelSelect.value = savedModel;
      }
      try{ chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]"); } catch(e){}
      renderChatHistory();
      updateHeaderAndButton();
      const hintMessage = (chatHistory.length > 0) ? "üìö Historial de la sesi√≥n actual cargado." : "üÜï Nuevo chat iniciado.";
      displayMessage(hintMessage, "bot-message");
    });

    // Si quieres que el header se actualice en vivo al volver del perfil, puedes hacer:
    window.addEventListener("focus", updateUserHeaderFromProfile);
    // ... el resto de tu script igual ...
  </script>
</body>
</html>