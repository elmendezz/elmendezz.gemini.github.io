<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Servidor Gemini</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --bg:#121212; --text:#e0e0e0; --btn:#1a73e8; --btn-h:#1565c0;
      --input-bg:#2c2c2c; --input-border:#444; --chat-bg:#1e1e1e;
      --profile-bg:#4a4a4a; --code-bg:#2d2d2d;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Google Sans","Roboto",sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; height:100vh;
    }
    header{
      width:100%; display:flex; align-items:center; justify-content:center;
      padding:12px 16px; position:relative;
    }
    header h1{ color:var(--btn); font-size:20px; font-weight:500; cursor:pointer; }
    .menu-btn{ position:absolute; left:14px; font-size:24px; cursor:pointer; user-select:none; }
    .profile-btn{ position:absolute; right:14px; width:36px; height:36px; border-radius:50%; background:var(--profile-bg); color:white; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:18px; }

    /* Sidebar */
    .sidebar{
      position:fixed; top:0; left:-260px; width:250px; height:100%;
      background:#1e1e1e; padding:18px; display:flex; flex-direction:column; gap:12px;
      transition:left .28s ease; z-index:999;
    }
    .sidebar.open{ left:0; }
    .sidebar button{ background:var(--btn); color:white; border:none; border-radius:16px; padding:10px 12px; text-align:left; cursor:pointer; }
    .overlay{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:998; }
    .overlay.show{ display:block; }

    main{
      flex-grow:1; width:100%; max-width:640px; display:flex; flex-direction:column; gap:12px;
      padding:12px; margin-bottom:86px; overflow-y:auto;
    }
    #chat-window{
      flex-grow:1; background:var(--chat-bg); border-radius:12px; padding:16px; display:flex; flex-direction:column; gap:10px; min-height:220px; overflow:auto;
    }
    .user-message, .bot-message{
      padding:10px 14px; border-radius:18px; max-width:80%; word-wrap:break-word;
    }
    .user-message{ align-self:flex-end; background:var(--btn); color:#fff; }
    .bot-message{ align-self:flex-start; background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); }
    .bot-message pre{ background:var(--code-bg); padding:10px; border-radius:8px; overflow-x:auto; }

    footer{
      width:100%; max-width:640px; padding:10px; position:sticky; bottom:0; background:var(--bg); z-index:20;
    }
    .input-area{ display:flex; gap:8px; align-items:flex-end; }
    textarea#promptInput{
      flex-grow:1; background:var(--input-bg); border:1px solid var(--input-border);
      border-radius:18px; padding:10px 14px; font-size:15px; color:var(--text); outline:none;
      resize:none; max-height:160px; overflow:auto;
    }
    button.send-btn{ background:var(--btn); color:white; border:none; border-radius:16px; padding:10px 14px; cursor:pointer; }
    button.send-btn:disabled{ opacity:.5; cursor:not-allowed; }
    
    .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        border-radius: 16px;
        background: var(--input-bg);
        border: 1px solid var(--input-border);
        padding: 10px 14px;
        cursor: pointer;
    }
    .file-input-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }
    #fileNameDisplay {
        font-size: 12px;
        color: var(--text);
        margin-top: 5px;
        text-align: right;
    }
    
    /* Selector de modelos */
    .model-selector{
        margin-top: 10px;
        width: 100%;
        max-width: 640px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
    }
    .model-selector label {
        font-size: 14px;
        opacity: 0.8;
    }
    .model-selector select {
        background: var(--input-bg);
        color: var(--text);
        border: 1px solid var(--input-border);
        border-radius: 8px;
        padding: 6px 8px;
        outline: none;
    }

    /* Modal de c√≥digo */
    #code-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:1000; align-items:center; justify-content:center; }
    #code-modal.active{ display:flex; }
    .code-content{ background:var(--bg); border-radius:12px; padding:18px; max-width:90%; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
    .code-content h2{ margin-bottom:12px; font-size:18px; }
    .code-content pre{ background:var(--code-bg); padding:12px; border-radius:8px; overflow-y:auto; flex-grow:1; font-family:monospace; }
    .code-modal-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .code-modal-actions button{ background:#4a4a4a; color:white; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    <h1 id="header-title" onclick="location.href='about.html'">Servidor Gemini</h1>
    <button class="profile-btn" onclick="location.href='perfil.html'">üë§</button>
  </header>

  <div class="sidebar" id="sidebar">
    <button onclick="newChat()">üÜï Nuevo chat</button>
    <button id="memoryBtn" onclick="toggleMemory()">üö´ Chat sin memoria</button>
    <button onclick="goToConversationsPage()">üìú Ver conversaciones</button>
    <button onclick="location.href='config.html'">‚öôÔ∏è Configuraci√≥n</button>
    <button onclick="clearAllHistory()">‚ùå Borrar todo el historial</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <main>
    <div id="chat-window"></div>
  </main>

  <footer>
    <div class="input-area">
      <div class="file-input-wrapper" title="Adjuntar archivo">
        üìé
        <input type="file" id="fileInput" multiple>
      </div>
      <textarea id="promptInput" rows="1" placeholder="Escribe tu pregunta..."></textarea>
      <button id="sendBtn" class="send-btn" onclick="askGemini()">Enviar</button>
    </div>
    <div class="model-selector">
        <label for="modelSelect">Modelo:</label>
        <select id="modelSelect">
            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        </select>
    </div>
    <div id="fileNameDisplay"></div>
  </footer>

  <div id="code-modal">
    <div class="code-content">
      <pre><code id="code-display"></code></pre>
      <div class="code-modal-actions">
        <button onclick="closeCodeModal()">Cerrar</button>
        <button onclick="copyCode()">Copiar</button>
      </div>
    </div>
  </div>

  <script>
    // BOT Version:6.1
    const DEFAULT_API_KEY = "AIzaSyB6HxCfyney7oI1DX8fbmpJVbS7ApiRhUE";
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
    let memoryEnabled = true;
    let chatHistory = [];
    let attachedFiles = [];
    
    // Configuraci√≥n de Marked con renderizador personalizado
    const renderer = {
      code(code, lang) {
        return `<pre><code>${code}</code></pre><div style="text-align:right;margin-top:8px;"><button onclick="showCodeModal(this, '${lang}')" style="background:none;border:none;color:var(--btn);text-decoration:underline;cursor:pointer;">Ver c√≥digo completo</button><textarea style="display:none">${code}</textarea></div>`;
      }
    };
    marked.use({ renderer });

    // Funciones del modal de c√≥digo
    function showCodeModal(button, lang) {
      const code = button.nextSibling.value;
      const modal = document.getElementById('code-modal');
      const display = document.getElementById('code-display');
      display.textContent = code;
      modal.classList.add('active');
    }

    function closeCodeModal() {
      document.getElementById('code-modal').classList.remove('active');
    }

    function copyCode() {
      const code = document.getElementById('code-display').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert("‚úÖ C√≥digo copiado al portapapeles.");
      }).catch(err => {
        alert("‚ùå No se pudo copiar: " + err);
      });
    }

    // L√≥gica para adjuntar archivos
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = e.target.files;
        attachedFiles = [];
        const fileDisplay = document.getElementById('fileNameDisplay');
        fileDisplay.innerHTML = '';

        if (files.length > 0) {
            let names = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                names.push(file.name);
                const base64 = await toBase64(file);
                const mimeType = file.type;
                attachedFiles.push({
                    inlineData: {
                        data: base64.split(',')[1],
                        mimeType: mimeType
                    }
                });
            }
            fileDisplay.innerText = `Archivos adjuntos: ${names.join(', ')}`;
        }
    });

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    // L√≥gica para guardar conversaciones
    function getSavedConversations() {
      try {
        return JSON.parse(localStorage.getItem('conversations') || '[]');
      } catch (e) {
        console.error("Error al cargar las conversaciones:", e);
        return [];
      }
    }

    function checkIfConversationExists(currentChat) {
      if (currentChat.length === 0) return false;
      const savedConversations = getSavedConversations();
      const currentChatStr = JSON.stringify(currentChat);
      return savedConversations.some(conv => JSON.stringify(conv.messages) === currentChatStr);
    }

    function saveCurrentConversation(currentChat) {
      if (checkIfConversationExists(currentChat)) {
        return;
      }
      
      const conversations = getSavedConversations();
      const firstMessage = currentChat[0].text.substring(0, 50) + "...";
      const newConversation = {
        id: Date.now(),
        title: firstMessage,
        messages: currentChat,
        timestamp: new Date().toISOString()
      };
      
      conversations.unshift(newConversation);
      try {
        localStorage.setItem('conversations', JSON.stringify(conversations));
      } catch(e) {
        console.warn("No se pudo guardar la conversaci√≥n:", e);
      }
    }

    // L√≥gica de la interfaz
    function toggleMenu(){
      document.getElementById("sidebar").classList.toggle("open");
      document.getElementById("overlay").classList.toggle("show");
    }

    function displayMessage(text, className){
      const chatWindow = document.getElementById("chat-window");
      const el = document.createElement("div");
      el.className = className;
      try{ el.innerHTML = marked.parse(String(text)); } catch(e){ el.textContent = text; }
      chatWindow.appendChild(el);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      return el;
    }

    // Mejorada para manejar mensajes con y sin archivos
    function renderChatHistory() {
      const chatWindow = document.getElementById("chat-window");
      chatWindow.innerHTML = "";
      if (chatHistory.length > 0) {
        chatHistory.forEach(msg => {
          if (msg.role === 'user') {
            let userText = "";
            let fileCount = 0;
            if (msg.parts && Array.isArray(msg.parts)) {
              msg.parts.forEach(part => {
                if (part.text) {
                  userText = part.text;
                } else if (part.inlineData) {
                  fileCount++;
                }
              });
            }
            if (userText) {
              displayMessage(userText, "user-message");
            }
            if (fileCount > 0) {
              displayMessage(`üìé Archivos adjuntos: ${fileCount}`, 'user-message');
            }
          } else if (msg.role === 'model' && msg.text) {
            displayMessage(msg.text, "bot-message");
          }
        });
      }
    }

    async function askGemini(){
      const input = document.getElementById("promptInput");
      const sendBtn = document.getElementById("sendBtn");
      const modelSelect = document.getElementById("modelSelect");
      const fileDisplay = document.getElementById('fileNameDisplay');
      
      const raw = input.value.trim();
      if(!raw && attachedFiles.length === 0) return;
      
      const userContent = { role: "user", parts: [] };
      if (raw) {
          userContent.parts.push({ text: raw });
      }
      if (attachedFiles.length > 0) {
          userContent.parts.push(...attachedFiles);
      }

      displayMessage(raw, "user-message");
      if (attachedFiles.length > 0) {
          fileDisplay.innerText = '';
          displayMessage(`üìé Archivos adjuntos: ${attachedFiles.length}`, 'user-message');
      }

      input.value = ""; input.style.height = "auto";
      document.getElementById('fileInput').value = '';
      attachedFiles = [];
      
      const API_KEY = localStorage.getItem("gemini_api") || DEFAULT_API_KEY;
      const modelName = modelSelect.value;
      sendBtn.disabled = true;
      const loadingEl = displayMessage("‚åõ Pensando...", "bot-message");

      try{
        let contents = [];
        if(memoryEnabled && chatHistory.length > 0){
          // Limpia y reconstruye el historial para evitar errores de API
          const cleanedHistory = chatHistory.filter(c => c.role === 'user' || c.role === 'model');
          contents = cleanedHistory.map(c => {
              if (c.parts && c.parts.length > 0) {
                  // Asegura que cada parte tenga texto o datos v√°lidos
                  const validParts = c.parts.filter(p => p.text || (p.inlineData && p.inlineData.data));
                  return { role: c.role, parts: validParts };
              } else if (c.text) {
                  // Mantiene la compatibilidad con el formato antiguo
                  return { role: c.role, parts: [{ text: c.text }] };
              }
              return null;
          }).filter(c => c && c.parts && c.parts.length > 0);
        }
        contents.push(userContent);
        
        const resp = await fetch(`${API_URL}${modelName}:generateContent?key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents })
        });
        const data = await resp.json();
        loadingEl.remove();

        let botText = "‚ùå Error en la respuesta";
        if(data.error && data.error.message){
          botText = `Error: ${data.error.message}`;
        } else if (data.candidates && data.candidates[0] && data.candidates[0].content){
          botText = data.candidates[0].content.parts[0].text || botText;
        }

        displayMessage(botText, "bot-message");
        if(memoryEnabled){
          chatHistory.push(userContent);
          chatHistory.push({ role: "model", text: botText });
          try{ localStorage.setItem("chatHistory", JSON.stringify(chatHistory)); } catch(e){ console.warn("No se pudo guardar historial:", e); }
        }
      }catch(err){
        loadingEl.remove();
        displayMessage("üö® Error de conexi√≥n: " + (err.message || err), "bot-message");
      } finally {
        sendBtn.disabled = false;
      }
    }

    function newChat(){
      saveCurrentConversation(chatHistory);
      chatHistory = [];
      try{ localStorage.setItem("chatHistory","[]"); }catch(e){}
      renderChatHistory();
      memoryEnabled = true;
      updateHeaderAndButton();
      displayMessage("üÜï Nuevo chat iniciado.", "bot-message");
      toggleMenu();
    }

    function goToConversationsPage() {
      saveCurrentConversation(chatHistory);
      location.href = 'conversaciones.html';
    }

    function toggleMemory(){
      memoryEnabled = !memoryEnabled;
      updateHeaderAndButton();
      const message = memoryEnabled ? "‚úÖ Modo con memoria activado." : "üö´ Modo sin memoria activado.";
      displayMessage(message, "bot-message");
      toggleMenu();
    }

    function updateHeaderAndButton() {
      const headerTitle = document.getElementById("header-title");
      const memoryBtn = document.getElementById("memoryBtn");
      if (memoryEnabled) {
        headerTitle.innerText = "Servidor Gemini";
        memoryBtn.innerHTML = "üö´ Chat sin memoria";
      } else {
        headerTitle.innerText = "Servidor Gemini üîí";
        memoryBtn.innerHTML = "‚úÖ Chat con memoria";
      }
    }

    function clearAllHistory(){
      if(!confirm("¬øEst√°s seguro de que quieres borrar TODAS las conversaciones guardadas? Esto es irreversible.")) return;
      localStorage.removeItem("chatHistory");
      localStorage.removeItem("conversations");
      chatHistory = [];
      renderChatHistory();
      displayMessage("üóëÔ∏è Todo el historial de conversaciones borrado.", "bot-message");
      toggleMenu();
    }
    
    // Auto-expand textarea
    const promptInput = document.getElementById("promptInput");
    promptInput.addEventListener("input", () => {
      promptInput.style.height = "auto";
      promptInput.style.height = (promptInput.scrollHeight) + "px";
      document.getElementById("chat-window").scrollTop = document.getElementById("chat-window").scrollHeight;
    });

    promptInput.addEventListener("focus", () => {
      setTimeout(()=> {
        document.getElementById("chat-window").scrollTop = document.getElementById("chat-window").scrollHeight;
      }, 300);
    });

    promptInput.addEventListener("keypress", e => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        askGemini();
      }
    });

    // Guardar modelo seleccionado en localStorage
    document.getElementById("modelSelect").addEventListener("change", (e) => {
        try {
            localStorage.setItem("gemini_model", e.target.value);
            displayMessage(`El modelo ha sido cambiado a **${e.target.value}**`, "bot-message");
        } catch (err) {
            console.error("Error al guardar el modelo seleccionado:", err);
        }
    });

    // Cargar modelo guardado al iniciar la p√°gina
    document.addEventListener("DOMContentLoaded", () => {
        const savedModel = localStorage.getItem("gemini_model");
        const modelSelect = document.getElementById("modelSelect");
        if (savedModel && Array.from(modelSelect.options).some(opt => opt.value === savedModel)) {
            modelSelect.value = savedModel;
        }

        try{ chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]"); } catch(e){}
        renderChatHistory();
        updateHeaderAndButton();
        const hintMessage = (chatHistory.length > 0) ? "üìö Historial de la sesi√≥n actual cargado." : "üÜï Nuevo chat iniciado.";
        displayMessage(hintMessage, "bot-message");
    });
  </script>
</body>
</html>
