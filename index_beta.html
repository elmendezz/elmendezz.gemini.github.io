<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini Beta</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #0b0c0f;
      --text: #e0e0e0;
      --primary: #1e88e5; /* Azul primario */
      --secondary: #333;
      --card-bg: #1c1c1f;
      --input-bg: #212124;
      --text-muted: #8e9092;
      --border-color: #3e3e41;
      --icon-color: #9aa0a6;
      --accent: #2c2d30;
      --code-bg: #151618;
      --user-bubble: #1e88e5;
      --bot-bubble: #313134;
      --bot-border: #444;
      --recording-color: #e53935;
    }
    
    body {
      font-family: "Google Sans", "Roboto", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    header {
      width: 100%;
      display: flex;
      flex-direction: column; /* Cambiado a columna para apilar elementos */
      align-items: center;
      justify-content: center;
      padding: 12px 16px;
      position: relative;
    }
    
    header h1 {
      color: var(--primary);
      font-size: 20px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 8px; /* Espacio entre el t√≠tulo y el selector */
    }
    
    .menu-btn, .profile-btn {
      position: absolute;
      top: 14px; /* Ajuste para que no se superponga */
      font-size: 24px;
      cursor: pointer;
      color: var(--icon-color);
    }
    
    .menu-btn { left: 14px; }
    .profile-btn { right: 14px; width: 36px; height: 36px; border-radius: 50%; background: var(--secondary); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; overflow: hidden; }
    .profile-btn img { width: 100%; height: 100%; object-fit: cover; }
    
    .sidebar {
      position: fixed; top: 0; left: -260px; width: 250px; height: 100%;
      background: #1e1e1e; padding: 18px; display: flex; flex-direction: column;
      gap: 12px; transition: left .28s ease; z-index: 999;
    }
    
    .sidebar.open { left: 0; }
    .sidebar button {
      background: var(--card-bg); color: var(--text); border: none;
      border-radius: 12px; padding: 10px 12px; text-align: left; cursor: pointer;
      transition: background 0.2s;
    }
    
    .sidebar button:hover { background: var(--secondary); }
    .overlay {
      display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, .6);
      z-index: 998;
    }
    
    .overlay.show { display: block; }
    
    main {
      flex-grow: 1; 
      width: 100%; 
      max-width: 720px;
      padding: 12px; 
      padding-bottom: 90px;
      margin: 0 auto; 
      overflow-y: auto;
      display: flex; 
      flex-direction: column; 
      gap: 16px;
      scroll-behavior: smooth;
    }
    
    .user-message, .bot-message {
      padding: 14px 18px; border-radius: 20px; max-width: 90%; word-wrap: break-word;
      font-size: 15px;
    }
    
    .user-message {
      align-self: flex-end; background: var(--user-bubble); color: #fff;
      border-bottom-right-radius: 4px;
    }
    
    .bot-message {
      align-self: flex-start; background: var(--bot-bubble); color: var(--text);
      border: 1px solid var(--bot-border); border-bottom-left-radius: 4px;
      padding: 16px;
    }
    
    .bot-message pre {
      background: var(--code-bg); padding: 10px; border-radius: 8px;
      overflow-x: auto;
    }
    
    #chat-window {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
    }
    
    footer {
      width: 100%; max-width: 720px; padding: 10px; 
      position: fixed;
      bottom: 0; 
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg); z-index: 20;
    }
    
    .input-area {
      display: flex; gap: 8px; align-items: flex-end;
      background: var(--input-bg); border-radius: 24px; padding: 8px 12px;
      border: 1px solid var(--border-color);
    }
    
    textarea#promptInput {
      flex-grow: 1; background: transparent; border: none; outline: none;
      font-size: 15px; color: var(--text); resize: none; max-height: 160px;
      overflow: auto;
    }
    
    .input-icons {
      display: flex; gap: 4px; align-items: flex-end;
      padding-bottom: 4px;
    }
    
    button.icon-btn {
      background: none; border: none; color: var(--icon-color);
      font-size: 20px; cursor: pointer; padding: 4px;
    }
    
    button.send-btn {
      background: var(--primary); color: white; border: none; border-radius: 50%;
      width: 38px; height: 38px; display: flex; align-items: center;
      justify-content: center; font-size: 18px; cursor: pointer;
    }
    
    button.send-btn:disabled { opacity: .5; cursor: not-allowed; }
    
    #micBtn.recording {
        background-color: var(--recording-color);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 57, 53, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(229, 57, 53, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 57, 53, 0); }
    }
    
    /* Selector de modelos en el encabezado */
    .model-selector {
        margin: 0 auto;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-muted);
        width: 100%;
        max-width: 720px;
        position: relative;
    }
    
    .model-selector label { opacity: 0.8; }
    .model-selector select {
        background: var(--accent); color: var(--text);
        border: 1px solid var(--border-color); border-radius: 6px;
        padding: 4px 6px; outline: none; font-size: 12px;
    }
    
    .intro-suggestions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        padding: 24px;
        margin-top: auto;
    }
    
    .suggestion-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
        cursor: pointer;
        transition: transform 0.2s, background 0.2s;
    }
    
    .suggestion-card:hover {
        transform: translateY(-2px);
        background: var(--secondary);
    }
    
    .suggestion-card p {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 4px;
    }
    
    .suggestion-card span {
        font-size: 12px;
        color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    <button class="profile-btn" onclick="location.href='perfil.html'">
      <img id="profile-btn-avatar" src="https://via.placeholder.com/36" alt="Avatar">
    </button>
    <h1 id="header-title" onclick="location.href='about.html'">Gemini Beta</h1>
    <div class="model-selector">
      <label for="modelSelect">Modelo:</label>
      <select id="modelSelect">
        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
      </select>
    </div>
  </header>

  <div class="sidebar" id="sidebar">
    <button onclick="newChat()">üÜï Nuevo chat</button>
    <button id="memoryBtn" onclick="toggleMemory()">üö´ Chat sin memoria</button>
    <button onclick="goToConversationsPage()">üìú Ver conversaciones</button>
    <button onclick="location.href='config.html'">‚öôÔ∏è Configuraci√≥n</button>
    <button onclick="clearAllHistory()">‚ùå Borrar todo el historial</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <main id="main-content">
    <div class="intro-suggestions" id="intro-suggestions">
      <div class="suggestion-card" onclick="document.getElementById('promptInput').value='Dime qu√© puedes hacer'; askGemini();">
        <p>¬øQu√© puedes hacer?</p>
        <span>Explora tus capacidades</span>
      </div>
      <div class="suggestion-card" onclick="document.getElementById('promptInput').value='Ay√∫dame a planificar'; askGemini();">
        <p>Planifica tu d√≠a</p>
        <span>Crea una agenda o lista</span>
      </div>
      <div class="suggestion-card" onclick="document.getElementById('promptInput').value='Investiga un tema'; askGemini();">
        <p>Investiga un tema</p>
        <span>Obt√©n informaci√≥n detallada</span>
      </div>
    </div>
    <div id="chat-window" style="display: none;"></div>
  </main>

  <footer>
    <div class="input-area">
      <div class="input-icons">
        <label for="fileInput" class="icon-btn">üìé</label>
        <input type="file" id="fileInput" multiple style="display: none;">
        <button id="micBtn" class="icon-btn">üé§</button>
      </div>
      <textarea id="promptInput" rows="1" placeholder="Preg√∫ntale a Gemini..."></textarea>
      <button id="sendBtn" class="send-btn">‚ûî</button>
    </div>
  </footer>

  <script>
    const DEFAULT_API_KEY = "AIzaSyB6HxCfyney7oI1DX8fbmpJVbS7ApiRhUE";
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/";
    let memoryEnabled = true;
    let chatHistory = [];
    let attachedFiles = [];
    
    // Configuraci√≥n de Marked con renderizador personalizado
    const renderer = {
      code(code, lang) {
        return `<pre><code>${code}</code></pre>`;
      }
    };
    marked.use({ renderer });

    // L√≥gica para adjuntar archivos
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = e.target.files;
        attachedFiles = [];
        if (files.length > 0) {
            let names = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                names.push(file.name);
                const base64 = await toBase64(file);
                const mimeType = file.type;
                attachedFiles.push({
                    inlineData: {
                        data: base64.split(',')[1],
                        mimeType: mimeType
                    }
                });
            }
            displayMessage(`üìé Archivos adjuntos: ${names.join(', ')}`, "user-message");
        }
    });

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function displayMessage(text, className) {
        const chatWindow = document.getElementById("chat-window");
        const el = document.createElement("div");
        el.className = className;
        try { el.innerHTML = marked.parse(String(text)); } catch(e) { el.textContent = text; }
        chatWindow.appendChild(el);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        document.getElementById("intro-suggestions").style.display = 'none';
        chatWindow.style.display = 'flex';
        return el;
    }

    async function askGemini() {
      const input = document.getElementById("promptInput");
      const sendBtn = document.getElementById("sendBtn");
      const modelSelect = document.getElementById("modelSelect");
      const raw = input.value.trim();
      if(!raw && attachedFiles.length === 0) return;
      
      const userContent = { role: "user", parts: [] };
      if (raw) {
          userContent.parts.push({ text: raw });
      }
      if (attachedFiles.length > 0) {
          userContent.parts.push(...attachedFiles);
      }

      displayMessage(raw, "user-message");
      input.value = ""; input.style.height = "auto";
      document.getElementById('fileInput').value = '';
      attachedFiles = [];
      
      const API_KEY = localStorage.getItem("gemini_api") || DEFAULT_API_KEY;
      if (!API_KEY || API_KEY === DEFAULT_API_KEY) {
          displayMessage("üö® **Alerta:** Est√°s usando la API Key por defecto. Guarda tu propia key en la 'Configuraci√≥n'.", "bot-message");
      }
      const modelName = modelSelect.value;
      sendBtn.disabled = true;
      const loadingEl = displayMessage("‚åõ Pensando...", "bot-message");

      try {
        let contents = [];
        if (memoryEnabled && chatHistory.length > 0) {
          const cleanedHistory = chatHistory.map(c => {
            const validParts = c.role === 'user' ? 
              c.parts.filter(p => p.text || (p.inlineData && p.inlineData.data)) :
              [{ text: c.text }]; // Crea un objeto parts para el mensaje del bot
            return { role: c.role, parts: validParts };
          }).filter(c => c.parts.length > 0);
          contents = cleanedHistory;
        }
        contents.push(userContent);
        
        const resp = await fetch(`${API_URL}${modelName}:generateContent?key=${API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents })
        });
        const data = await resp.json();
        loadingEl.remove();

        let botText = "‚ùå Error en la respuesta";
        if(data.error && data.error.message){
          botText = `Error: ${data.error.message}`;
          if(data.error.message.includes('API key not valid')) {
            botText = `‚ùå Error: La API Key no es v√°lida. Por favor, revisa tu clave en la Configuraci√≥n.`;
          }
        } else if (data.candidates && data.candidates[0] && data.candidates[0].content){
          botText = data.candidates[0].content.parts[0].text || botText;
        }

        displayMessage(botText, "bot-message");
        if (memoryEnabled) {
          chatHistory.push(userContent);
          chatHistory.push({ role: "model", text: botText });
          try{ localStorage.setItem("chatHistory", JSON.stringify(chatHistory)); } catch(e){ console.warn("No se pudo guardar historial:", e); }
        }
      } catch(err) {
        loadingEl.remove();
        displayMessage("üö® Error de conexi√≥n: " + (err.message || err), "bot-message");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Funciones del men√∫ lateral
    function toggleMenu(){
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("overlay");
        if(sidebar && overlay){
            sidebar.classList.toggle("open");
            overlay.classList.toggle("show");
        }
    }
    function newChat(){
        chatHistory = [];
        try{ localStorage.setItem("chatHistory","[]"); }catch(e){}
        location.reload();
    }
    function goToConversationsPage() {
        location.href = 'conversaciones.html';
    }
    function toggleMemory(){
        memoryEnabled = !memoryEnabled;
        const memoryBtn = document.getElementById("memoryBtn");
        const message = memoryEnabled ? "‚úÖ Modo con memoria activado." : "üö´ Modo sin memoria activado.";
        if(memoryBtn){
            memoryBtn.innerHTML = memoryEnabled ? "üö´ Chat sin memoria" : "‚úÖ Chat con memoria";
        }
        displayMessage(message, "bot-message");
        toggleMenu();
    }
    function clearAllHistory(){
      if(!confirm("¬øEst√°s seguro de que quieres borrar TODAS las conversaciones guardadas? Esto es irreversible.")) return;
      localStorage.removeItem("chatHistory");
      localStorage.removeItem("conversations");
      chatHistory = [];
      location.reload();
      alert("üóëÔ∏è Todo el historial de conversaciones borrado.");
    }
    
    // L√≥gica para el bot√≥n de enviar y la tecla Enter
    document.getElementById("sendBtn").addEventListener("click", askGemini);
    document.getElementById("promptInput").addEventListener("keypress", e => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        askGemini();
      }
    });

    // L√≥gica para auto-expandir el textarea
    const promptInput = document.getElementById("promptInput");
    promptInput.addEventListener("input", () => {
      promptInput.style.height = "auto";
      promptInput.style.height = (promptInput.scrollHeight) + "px";
    });

    // L√≥gica de la API de Voz
    const micBtn = document.getElementById('micBtn');
    let recognition;
    let isRecording = false;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'es-ES';
      recognition.interimResults = false;
      
      recognition.onstart = () => { isRecording = true; if(micBtn) micBtn.classList.add('recording'); if(micBtn) micBtn.innerHTML = 'üî¥'; if(promptInput) promptInput.placeholder = "üé§ Escuchando..."; };
      recognition.onresult = (event) => { if(promptInput) promptInput.value = event.results[0][0].transcript; if(promptInput) promptInput.style.height = 'auto'; askGemini(); };
      recognition.onend = () => { isRecording = false; if(micBtn) micBtn.classList.remove('recording'); if(micBtn) micBtn.innerHTML = 'üé§'; if(promptInput) promptInput.placeholder = "Preg√∫ntale a Gemini..."; };
      recognition.onerror = (event) => {
        console.error("Error de reconocimiento de voz:", event.error);
        if (event.error !== 'no-speech') { displayMessage(`‚ùå Error en el audio: ${event.error}`, 'bot-message'); }
        if(micBtn) micBtn.classList.remove('recording'); if(micBtn) micBtn.innerHTML = 'üé§'; if(promptInput) promptInput.placeholder = "Preg√∫ntale a Gemini...";
      };
      if(micBtn) {
          micBtn.addEventListener("click", () => {
              if (!isRecording) { try { recognition.start(); } catch (e) { console.error("Error al iniciar el reconocimiento:", e); } } else { recognition.stop(); }
          });
      }
    } else {
      if(micBtn) micBtn.style.display = 'none';
    }

    // L√≥gica de inicializaci√≥n
    document.addEventListener("DOMContentLoaded", () => {
      // Cargar modelo guardado
      const savedModel = localStorage.getItem("gemini_model");
      const modelSelect = document.getElementById("modelSelect");
      if (modelSelect && savedModel && Array.from(modelSelect.options).some(opt => opt.value === savedModel)) {
          modelSelect.value = savedModel;
      }
      
      // Asegurar que el men√∫ y el overlay est√©n ocultos al cargar
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      if(sidebar && overlay) {
          sidebar.classList.remove("open");
          overlay.classList.remove("show");
      }
      
      // Cargar el historial del chat
      try {
        const history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
        if (history.length > 0) {
          chatHistory = history;
          document.getElementById("intro-suggestions").style.display = 'none';
          document.getElementById("chat-window").style.display = 'flex';
          history.forEach(msg => {
            const isUser = msg.role === 'user';
            const textContent = isUser ? (msg.parts && msg.parts[0] ? msg.parts[0].text : '') : (msg.text || '');
            if (textContent) {
              displayMessage(textContent, isUser ? 'user-message' : 'bot-message');
            } else if (isUser && msg.parts && msg.parts.some(p => p.inlineData)) {
              displayMessage(`üìé Archivo adjunto`, 'user-message');
            }
          });
        }
      } catch (e) {
        console.error("Error al cargar el historial:", e);
      }
      
      // Cargar el avatar del perfil
      const profileBtn = document.getElementById('profile-btn-avatar');
      const savedProfile = JSON.parse(localStorage.getItem('userProfile'));
      if (profileBtn && savedProfile) {
        if (savedProfile.avatarUrl) {
          profileBtn.src = savedProfile.avatarUrl;
        } else if (savedProfile.avatarBase64) {
          profileBtn.src = savedProfile.avatarBase64;
        }
      }
    });
  </script>
</body>
</html>